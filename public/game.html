<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <title>Color Prediction Arena</title>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>Color Arena</h1>
            <div class="balance-box">
                <p>Balance</p>
                <span id="balance">₹--.--</span>
            </div>
        </div>
        <div class="timer-card">
            <h3 id="phase-text">Connecting to Arena...</h3>
            <div id="countdown-bar-container">
                <div id="countdown-bar"></div>
            </div>
        </div>
        <div id="result-display"></div>
        <div class="bet-controls">
            <input type="number" id="betAmount" placeholder="Enter Bet Amount" min="1">
            <div class="color-buttons">
                <button class="color-btn red" onclick="placeBet('red')">RED</button>
                <button class="color-btn green" onclick="placeBet('green')">GREEN</button>
                <button class="color-btn blue" onclick="placeBet('blue')">BLUE</button>
            </div>
            <p id="message" style="min-height: 24px; margin-top: 15px;"></p>
        </div>
        <div class="live-bets-feed">
            <h3>Live Bets</h3>
            <div id="liveBetsList"></div>
        </div>
    </div>
    <nav class="footer-nav">
        <!-- ... your footer nav html ... -->
    </nav>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) window.location.href = '/login.html';
        const socket = io();
        const balanceEl = document.getElementById('balance');
        const messageEl = document.getElementById('message');
        const betInput = document.getElementById('betAmount');
        const colorButtons = document.querySelectorAll('.color-btn');
        const phaseEl = document.getElementById('phase-text');
        const resultDisplayEl = document.getElementById('result-display');
        const liveBetsListEl = document.getElementById('liveBetsList');
        const countdownBar = document.getElementById('countdown-bar');
        let userHasBet = false;
        let currentRoundId = '';
        socket.on('gameState', (state) => {
            if (currentRoundId !== state.roundId && state.phase === 'betting') {
                userHasBet = false;
                messageEl.textContent = 'Choose your color';
            }
            currentRoundId = state.roundId;
            const percentage = (state.timer / 15) * 100;
            countdownBar.style.width = `${percentage}%`;
            if (state.phase === 'betting') {
                phaseEl.innerHTML = `Place Bets! <span style="font-size: 0.7em; color: #a0a0a0;">#${currentRoundId.slice(-4)}</span>`;
                resultDisplayEl.innerHTML = '';
                setButtonsDisabled(userHasBet);
                let botsHtml = '';
                state.bots.forEach(bot => { botsHtml = `<div class="bet-item"><span class="player-name">${bot.name}</span><span class="bet-amount" style="color:${bot.color};">₹${bot.bet}</span></div>` + botsHtml; });
                liveBetsListEl.innerHTML = botsHtml;
            } else if (state.phase === 'result') {
                phaseEl.textContent = 'Round Over! Result:';
                setButtonsDisabled(true);
                resultDisplayEl.innerHTML = `<div class="result-text" style="background-color:${state.winningColor}; color: #fff; text-shadow: 0 0 10px #000;">${state.winningColor}</div>`;
                setTimeout(fetchBalance, 1000);
            }
        });
        function setButtonsDisabled(disabled) { colorButtons.forEach(b => b.disabled = disabled); }
        async function fetchBalance() { const res = await fetch('/api/game/balance', { headers: { 'x-auth-token': token }}); if (res.ok) { const data = await res.json(); balanceEl.textContent = `₹${data.balance.toFixed(2)}`; } else { window.location.href = '/login.html'; }}
        async function placeBet(chosenColor) {
            if (userHasBet) { messageEl.textContent = "You have already bet this round."; return; }
            const betAmount = Number(betInput.value);
            if (!betAmount || betAmount <= 0) { messageEl.textContent = "Please enter a valid amount."; return; }
            setButtonsDisabled(true);
            messageEl.textContent = `Betting ₹${betAmount} on ${chosenColor}...`;
            const res = await fetch('/api/game/play-color-game', { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-auth-token': token }, body: JSON.stringify({ betAmount, chosenColor }) });
            const data = await res.json();
            if (res.ok) {
                userHasBet = true;
                messageEl.textContent = `Your bet is placed! Good luck.`;
                balanceEl.textContent = `₹${data.newBalance.toFixed(2)}`;
            } else {
                messageEl.textContent = data.message;
                setButtonsDisabled(false);
            }
        }
        document.addEventListener('DOMContentLoaded', fetchBalance);
    </script>
</body>
</html>
