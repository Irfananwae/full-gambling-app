<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <title>Color Prediction Arena</title>
</head>
<body>
    <div class="game-container">
        <!-- Header with Balance -->
        <div class="game-header">
            <h1>Color Arena</h1>
            <div class="balance-box">
                <p>Balance</p>
                <span id="balance">₹--.--</span>
            </div>
        </div>

        <!-- Countdown Timer -->
        <div class="timer-card">
            <h3 id="phase-text">Connecting...</h3>
            <div id="countdown-bar-container">
                <div id="countdown-bar"></div>
            </div>
        </div>

        <!-- Result Display Area -->
        <div id="result-display"></div>

        <!-- Betting Controls -->
        <div class="bet-controls">
            <input type="number" id="betAmount" placeholder="Enter Bet Amount" min="1">
            <div class="color-buttons">
                <button class="color-btn red" onclick="placeBet('red')">RED</button>
                <button class="color-btn green" onclick="placeBet('green')">GREEN</button>
                <button class="color-btn blue" onclick="placeBet('blue')">BLUE</button>
            </div>
            <p id="message" style="min-height: 24px; margin-top: 15px;"></p>
        </div>

        <!-- Live Bets Feed -->
        <div class="live-bets-feed">
            <h3>Live Bets</h3>
            <div id="liveBetsList"></div>
        </div>

    </div>

    <!-- Footer Navigation (for easy exit) -->
    <nav class="footer-nav">
        <a href="/lobby.html" class="nav-item active"><i class="fas fa-gamepad"></i><span>Games</span></a>
        <a href="/deposit.html" class="nav-item"><i class="fas fa-wallet"></i><span>Deposit</span></a>
        <a href="/withdrawal.html" class="nav-item"><i class="fas fa-money-bill-wave"></i><span>Withdraw</span></a>
        <a href="/profile.html" class="nav-item"><i class="fas fa-user"></i><span>Profile</span></a>
    </nav>
    
    <!-- Socket.IO client library -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- SETUP ---
        const token = localStorage.getItem('authToken');
        if (!token) window.location.href = '/login.html';
        const socket = io();

        // --- ELEMENT REFERENCES ---
        const balanceEl = document.getElementById('balance');
        const messageEl = document.getElementById('message');
        const betInput = document.getElementById('betAmount');
        const colorButtons = document.querySelectorAll('.color-btn');
        const phaseEl = document.getElementById('phase-text');
        const resultDisplayEl = document.getElementById('result-display');
        const liveBetsListEl = document.getElementById('liveBetsList');
        const countdownBar = document.getElementById('countdown-bar');

        let userHasBet = false;
        let currentRoundId = '';

        // --- SOCKET.IO EVENT HANDLER ---
        socket.on('gameState', (state) => {
            currentRoundId = state.roundId; // Keep track of the current round
            
            // Update Countdown Bar
            const percentage = (state.timer / 15) * 100;
            countdownBar.style.width = `${percentage}%`;

            if (state.phase === 'betting') {
                phaseEl.textContent = `Place Your Bet! #${currentRoundId.slice(-4)}`;
                resultDisplayEl.innerHTML = '';
                setButtonsDisabled(false);
                userHasBet = false; // Reset betting status for new round
                messageEl.textContent = 'Choose your color';

                // Update Live Bets
                let botsHtml = '';
                state.bots.forEach(bot => {
                    botsHtml += `<div class="bet-item"><span class="player-name">${bot.name}</span><span class="bet-amount" style="color:${bot.color};">₹${bot.bet}</span></div>`;
                });
                liveBetsListEl.innerHTML = botsHtml;
            } else if (state.phase === 'result') {
                phaseEl.textContent = `Result for #${currentRoundId.slice(-4)}`;
                setButtonsDisabled(true);
                resultDisplayEl.innerHTML = `<div class="result-text" style="background-color:${state.winningColor}; color: #fff;">${state.winningColor}</div>`;
                // Check if user's bet won or lost after the result is announced
                setTimeout(fetchBalance, 1000); // Re-fetch balance to see result of bet
            }
        });

        function setButtonsDisabled(disabled) {
            colorButtons.forEach(b => b.disabled = disabled);
        }

        // --- BALANCE & BETTING ---
        async function fetchBalance() {
            const res = await fetch('/api/game/balance', { headers: { 'x-auth-token': token }});
            if (res.ok) {
                const data = await res.json();
                balanceEl.textContent = `₹${data.balance.toFixed(2)}`;
            } else {
                window.location.href = '/login.html';
            }
        }

        async function placeBet(chosenColor) {
            if (userHasBet) {
                messageEl.textContent = "You have already placed a bet for this round.";
                return;
            }
            const betAmount = Number(betInput.value);
            if (!betAmount || betAmount <= 0) {
                messageEl.textContent = "Please enter a valid bet amount.";
                return;
            }
            
            setButtonsDisabled(true); // Disable buttons after placing one bet
            messageEl.textContent = `Your bet of ₹${betAmount} on ${chosenColor} is placed!`;
            userHasBet = true;

            const res = await fetch('/api/game/play-color-game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                body: JSON.stringify({ betAmount, chosenColor, roundId: currentRoundId })
            });
            
            const data = await res.json();
            // Update balance immediately after placing bet
            balanceEl.textContent = `₹${data.newBalance.toFixed(2)}`; 
            // The win/loss result will be clear on the next balance fetch after the result phase
        }

        document.addEventListener('DOMContentLoaded', fetchBalance);
    </script>
</body>
</html>
